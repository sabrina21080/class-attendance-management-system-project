<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NU Class Attendance Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Scrollbar polish */
    ::-webkit-scrollbar{height:10px;width:10px}::-webkit-scrollbar-thumb{background:#e5e7eb;border-radius:9999px}
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- ===================== LOGIN ===================== -->
  <section id="loginPage" class="container mx-auto px-4 py-10 flex items-center justify-center">
    <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-8">
      <h1 class="text-3xl font-extrabold text-center">Teacher Login</h1>
      <p class="text-center text-gray-500 mt-1">National University • Demo prototype (localStorage only)</p>

      <form id="loginForm" class="mt-8 grid gap-4">
        <input id="teacherName" type="text" placeholder="Enter Teacher Name" class="w-full px-4 py-3 rounded-xl border outline-none focus:ring-2 focus:ring-blue-500" required />
        <input id="teacherId" type="text" placeholder="Enter Teacher ID" class="w-full px-4 py-3 rounded-xl border outline-none focus:ring-2 focus:ring-blue-500" required />
        <button class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl text-lg font-semibold">Login</button>
      </form>
    </div>
  </section>

  <!-- ===================== APP SHELL ===================== -->
  <div id="app" class="hidden">
    <!-- Top bar -->
    <header class="bg-white border-b">
      <div class="container mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-blue-600 text-white grid place-items-center font-bold">CA</div>
          <div>
            <div class="font-semibold">Class Attendance Management</div>
            <div class="text-xs text-gray-500">Simple, secure attendance for teachers</div>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <span id="whoami" class="text-sm text-gray-600"></span>
          <button id="logoutBtn" class="px-4 py-2 rounded-xl border bg-white hover:bg-gray-50">Logout</button>
        </div>
      </div>
    </header>

    <!-- Nav -->
    <nav class="container mx-auto px-4 mt-4">
      <div class="flex gap-2">
        <button data-tab="dashboard" class="tab px-3 py-2 rounded-lg bg-blue-600 text-white">Dashboard</button>
        <button data-tab="attendance" class="tab px-3 py-2 rounded-lg bg-white border">Attendance</button>
        <button data-tab="summary" class="tab px-3 py-2 rounded-lg bg-white border">Semester Summary</button>
      </div>
    </nav>

    <!-- ===================== DASHBOARD ===================== -->
    <main class="container mx-auto px-4 py-4">
      <section id="dashboardTab" class="grid md:grid-cols-3 gap-4">
        <div class="md:col-span-2 bg-white rounded-2xl shadow p-5">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-xl font-bold">My Courses</h2>
            <div class="text-sm text-gray-500">Total: <span id="courseCount">0</span></div>
          </div>
          <table class="w-full text-sm">
            <thead>
              <tr class="text-gray-500 border-b">
                <th class="text-left py-2">Course</th>
                <th class="text-left py-2">Department</th>
                <th class="text-left py-2">Class Time</th>
                <th class="text-left py-2">Students</th>
                <th class="text-right py-2">Actions</th>
              </tr>
            </thead>
            <tbody id="courseTbody"></tbody>
          </table>
        </div>

        <aside class="bg-white rounded-2xl shadow p-5">
          <h3 class="font-semibold mb-2">Quick Tips</h3>
          <ul class="list-disc pl-5 text-sm text-gray-600 space-y-1">
            <li>Pick a course and click <b>Take Attendance</b>.</li>
            <li>Save by date — all data lives in your browser.</li>
            <li>Use <b>Export CSV</b> to download records.</li>
          </ul>
        </aside>
      </section>

      <!-- ===================== ATTENDANCE ===================== -->
      <section id="attendanceTab" class="hidden">
        <!-- Controls -->
        <div class="bg-white rounded-2xl shadow p-5 mb-4">
          <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
            <div class="grid sm:grid-cols-3 gap-3 w-full">
              <div>
                <label class="text-xs text-gray-500">Course</label>
                <select id="courseSelect" class="w-full px-3 py-2 rounded-xl border mt-1"></select>
              </div>
              <div>
                <label class="text-xs text-gray-500">Date</label>
                <input id="attDate" type="date" class="w-full px-3 py-2 rounded-xl border mt-1" />
              </div>
              <div>
                <label class="text-xs text-gray-500">Search</label>
                <input id="search" type="text" placeholder="Search by name or ID" class="w-full px-3 py-2 rounded-xl border mt-1" />
              </div>
            </div>
            <div class="flex gap-2">
              <button id="exportCsv" class="px-4 py-2 rounded-xl bg-blue-600 text-white">Export CSV</button>
              <button id="exportAll" class="px-4 py-2 rounded-xl border">Export All Dates</button>
            </div>
          </div>
        </div>

        <div class="grid md:grid-cols-3 gap-4">
          <!-- Table -->
          <div class="md:col-span-2 bg-white rounded-2xl shadow p-5">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-semibold">Attendance Register</h3>
              <div class="text-sm text-gray-500">Saved dates: <b id="savedCount">0</b></div>
            </div>
            <div class="overflow-auto rounded-xl border">
              <table class="w-full text-sm" id="studentsTable">
                <thead class="bg-gray-50">
                  <tr class="text-gray-500">
                    <th class="text-left p-3 w-12">#</th>
                    <th class="text-left p-3">Name</th>
                    <th class="text-left p-3">Student ID</th>
                    <th class="text-left p-3">Status</th>
                    <th class="text-left p-3">Note</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="flex flex-wrap gap-2 mt-4">
              <button id="saveBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white">Save</button>
              <button id="markAllPresent" class="px-4 py-2 rounded-xl border bg-green-50">Mark All Present</button>
              <button id="markAllAbsent" class="px-4 py-2 rounded-xl border bg-red-50">Mark All Absent</button>
            </div>

            <div class="mt-6">
              <h4 class="font-semibold">Attendance Report</h4>
              <p class="text-sm text-gray-500">See attendance % for all students (this course)</p>
              <button id="showReport" class="mt-2 px-4 py-2 rounded-xl border">Show % Report</button>
              <div id="reportArea" class="hidden mt-3">
                <div id="reportList" class="divide-y"></div>
              </div>
            </div>
          </div>

          <!-- Tools -->
          <aside class="bg-white rounded-2xl shadow p-5 space-y-5">
            <div>
              <h4 class="font-semibold mb-2">Manage Students</h4>
              <form id="addForm" class="grid gap-2">
                <input id="stuName" type="text" placeholder="Student name" class="px-3 py-2 rounded-xl border" required />
                <input id="stuId" type="text" placeholder="Student ID (e.g. S001)" class="px-3 py-2 rounded-xl border" required />
                <div class="flex gap-2">
                  <button class="px-3 py-2 rounded-xl bg-blue-600 text-white" type="submit">Add</button>
                  <button id="randomBtn" class="px-3 py-2 rounded-xl border" type="button">Add Sample</button>
                </div>
              </form>
            </div>

            <div>
              <h4 class="font-semibold mb-2">Quick Actions</h4>
              <div class="flex flex-wrap gap-2">
                <button id="resetSample" class="px-3 py-2 rounded-xl border">Reset Sample</button>
                <button id="clearData" class="px-3 py-2 rounded-xl border">Clear All Data</button>
              </div>
            </div>

            <div>
              <h4 class="font-semibold mb-1">Legend</h4>
              <div class="flex gap-2 text-xs">
                <span class="px-2 py-1 rounded-full bg-green-100 text-green-700">Present</span>
                <span class="px-2 py-1 rounded-full bg-red-100 text-red-700">Absent</span>
              </div>
            </div>
          </aside>
        </div>
      </section>

      <!-- ===================== SEMESTER SUMMARY ===================== -->
      <section id="summaryTab" class="hidden bg-white rounded-2xl shadow p-5">
        <div class="grid md:grid-cols-3 gap-4 items-end">
          <div>
            <label class="text-xs text-gray-500">Course</label>
            <select id="summaryCourse" class="w-full px-3 py-2 rounded-xl border mt-1"></select>
          </div>
          <div>
            <label class="text-xs text-gray-500">From</label>
            <input id="fromDate" type="date" class="w-full px-3 py-2 rounded-xl border mt-1" />
          </div>
          <div>
            <label class="text-xs text-gray-500">To</label>
            <input id="toDate" type="date" class="w-full px-3 py-2 rounded-xl border mt-1" />
          </div>
          <div class="md:col-span-3">
            <button id="runSummary" class="px-4 py-2 rounded-xl bg-blue-600 text-white">Run Summary</button>
          </div>
        </div>
        <div id="summaryResult" class="mt-5"></div>
      </section>
    </main>
  </div>

  <!-- ===================== JS ===================== -->
  <script>
  // ---------- Constants & Storage Keys ----------
  const LS_TEACHER = 'nu_teacher_v1';
  const LS_COURSES = 'nu_courses_v1';           // array of courses
  const LS_STUDENTS = 'nu_students_v1';         // { [courseId]: [ {id,name} ] }
  const LS_ATT = 'nu_attendance_v1';            // { [courseId]: { [date]: [ {id,name,status,note} ] } }

  const SAMPLE_COURSES = [
    { id: 'CSE101', name: 'Web Development', dept: 'Computer Science', time: '10:00 AM - 11:30 AM' },
    { id: 'CSE202', name: 'Data Structures', dept: 'CSE', time: '12:00 PM - 01:30 PM' }
  ];
  const SAMPLE_STUDENTS = [
    { id: '21001', name: 'sabrina' },
    { id: '21002', name: 'akter' },
    { id: '21003', name: 'zannat' },
    { id: '21004', name: 'mim' },
    { id: '21005', name: 'sadia' }
  ];

  const $ = sel => document.querySelector(sel);

  // ---------- Helpers ----------
  const todayISO = () => new Date().toISOString().slice(0,10);
  const load = (k, d) => { try { return JSON.parse(localStorage.getItem(k)) ?? d; } catch { return d; } };
  const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

  function ensureSeed() {
    if (!load(LS_COURSES)) save(LS_COURSES, SAMPLE_COURSES);
    const stuMap = load(LS_STUDENTS) || {};
    SAMPLE_COURSES.forEach(c=>{ if(!stuMap[c.id]) stuMap[c.id] = [...SAMPLE_STUDENTS]; });
    save(LS_STUDENTS, stuMap);
    if (!load(LS_ATT)) save(LS_ATT, {});
  }

  // ---------- Login Flow ----------
  $('#loginForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const teacher = { name: $('#teacherName').value.trim(), id: $('#teacherId').value.trim() };
    if(!teacher.name || !teacher.id) return alert('Please enter both fields.');
    save(LS_TEACHER, teacher);
    boot();
  });

  $('#logoutBtn').addEventListener('click', () => {
    localStorage.removeItem(LS_TEACHER);
    location.reload();
  });

  function boot(){
    ensureSeed();
    const t = load(LS_TEACHER);
    if(!t){ $('#app').classList.add('hidden'); $('#loginPage').classList.remove('hidden'); return; }
    $('#whoami').textContent = `${t.name} (${t.id})`;
    $('#loginPage').classList.add('hidden');
    $('#app').classList.remove('hidden');
    renderCoursesTable();
    hydrateCourseSelectors();
    $('#attDate').value = todayISO();
    renderAttendanceTable();
  }

  // ---------- Tabs ----------
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(b=>{ b.classList.remove('bg-blue-600','text-white'); b.classList.add('bg-white','border'); });
      btn.classList.remove('bg-white','border');
      btn.classList.add('bg-blue-600','text-white');
      const tab = btn.dataset.tab;
      ['dashboard','attendance','summary'].forEach(id=>$('#'+id+'Tab').classList.add('hidden'));
      $('#'+tab+'Tab').classList.remove('hidden');
      if(tab==='summary') updateSummarySelectors();
    });
  });

  // ---------- Dashboard ----------
  function renderCoursesTable(){
    const courses = load(LS_COURSES, []);
    const stuMap = load(LS_STUDENTS, {});
    $('#courseCount').textContent = courses.length;
    const rows = courses.map(c=>{
      const n = (stuMap[c.id]||[]).length;
      return `<tr class="border-b">
        <td class="py-2">${escapeHtml(c.name)} (${c.id})</td>
        <td class="py-2">${escapeHtml(c.dept)}</td>
        <td class="py-2">${escapeHtml(c.time)}</td>
        <td class="py-2">${n}</td>
        <td class="py-2 text-right">
          <button class="px-3 py-1 rounded-lg bg-blue-600 text-white text-xs" onclick="gotoAttendance('${c.id}')">Take Attendance</button>
        </td>
      </tr>`;
    }).join('');
    $('#courseTbody').innerHTML = rows || `<tr><td colspan="5" class="text-center py-6 text-gray-500">No courses</td></tr>`;
  }

  function gotoAttendance(courseId){
    $('.tab[data-tab="attendance"]').click();
    $('#courseSelect').value = courseId;
    renderAttendanceTable();
  }

  // ---------- Attendance Page ----------
  function hydrateCourseSelectors(){
    const courses = load(LS_COURSES, []);
    const opts = courses.map(c=>`<option value="${escapeAttr(c.id)}">${escapeHtml(c.name)} (${c.id})</option>`).join('');
    $('#courseSelect').innerHTML = opts;
  }

  $('#courseSelect').addEventListener('change', ()=>{ renderAttendanceTable(); updateSavedCount(); });
  $('#attDate').addEventListener('change', ()=>{ renderAttendanceTable(); updateSavedCount(); });
  $('#search').addEventListener('input', (e)=> renderAttendanceTable(e.target.value));

  function renderAttendanceTable(filter=''){
    const courseId = $('#courseSelect').value || (load(LS_COURSES, [])[0]?.id);
    const date = $('#attDate').value || todayISO();
    if(!courseId) return;

    const stuMap = load(LS_STUDENTS, {});
    const attAll = load(LS_ATT, {});
    const savedRows = attAll?.[courseId]?.[date];
    const rows = savedRows || (stuMap[courseId]||[]).map(s=>({ ...s, status:'present', note:'' }));

    const q = filter.trim().toLowerCase();
    const tbody = $('#studentsTable tbody');
    tbody.innerHTML = '';
    rows.forEach((r, i)=>{
      if(q && !(String(r.name).toLowerCase().includes(q) || String(r.id).toLowerCase().includes(q))) return;
      const tr = document.createElement('tr');
      tr.className = 'border-b hover:bg-gray-50';
      tr.innerHTML = `
        <td class="p-3">${i+1}</td>
        <td class="p-3">${escapeHtml(r.name)}</td>
        <td class="p-3">${escapeHtml(r.id)}</td>
        <td class="p-3">
          <select class="status px-2 py-1 rounded-lg border" data-idx="${i}">
            <option value="present" ${r.status==='present'?'selected':''}>Present</option>
            <option value="absent" ${r.status==='absent'?'selected':''}>Absent</option>
          </select>
        </td>
        <td class="p-3"><input class="note w-full px-2 py-1 rounded-lg border" data-note-idx="${i}" value="${escapeAttr(r.note||'')}" placeholder="optional note"/></td>`;
      tbody.appendChild(tr);
    });

    updateSavedCount();
  }

  function updateSavedCount(){
    const courseId = $('#courseSelect').value;
    const all = load(LS_ATT, {});
    const obj = all[courseId] || {};
    $('#savedCount').textContent = Object.keys(obj).length;
  }

  function collectTable(){
    const tbody = $('#studentsTable tbody');
    const rows = [...tbody.querySelectorAll('tr')].map(tr=>{
      const tds = tr.querySelectorAll('td');
      return {
        name: tds[1].innerText,
        id: tds[2].innerText,
        status: tr.querySelector('select.status').value,
        note: tr.querySelector('input.note').value
      };
    });
    return rows;
  }

  $('#saveBtn').addEventListener('click', ()=>{
    const courseId = $('#courseSelect').value;
    const date = $('#attDate').value || todayISO();
    const rows = collectTable();
    const all = load(LS_ATT, {});
    if(!all[courseId]) all[courseId] = {};
    all[courseId][date] = rows;
    save(LS_ATT, all);
    updateSavedCount();
    alert('Saved attendance for '+date);
  });

  $('#markAllPresent').addEventListener('click', ()=>{
    document.querySelectorAll('#studentsTable select.status').forEach(s=> s.value='present');
  });
  $('#markAllAbsent').addEventListener('click', ()=>{
    document.querySelectorAll('#studentsTable select.status').forEach(s=> s.value='absent');
  });

  // Add/Reset/Clear
  $('#addForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const courseId = $('#courseSelect').value;
    const map = load(LS_STUDENTS, {});
    const name = $('#stuName').value.trim();
    const id = $('#stuId').value.trim();
    if(!name || !id) return alert('Enter name and ID');
    map[courseId] = map[courseId] || [];
    map[courseId].push({ id, name });
    save(LS_STUDENTS, map);
    $('#stuName').value=''; $('#stuId').value='';
    renderAttendanceTable($('#search').value);
    renderCoursesTable();
  });

  $('#randomBtn').addEventListener('click', ()=>{
    const s = SAMPLE_STUDENTS[Math.floor(Math.random()*SAMPLE_STUDENTS.length)];
    const map = load(LS_STUDENTS, {});
    const cid = $('#courseSelect').value;
    map[cid] = map[cid] || [];
    map[cid].push({...s, id: s.id + Math.floor(Math.random()*90+10)});
    save(LS_STUDENTS, map);
    renderAttendanceTable($('#search').value);
    renderCoursesTable();
  });

  $('#resetSample').addEventListener('click', ()=>{
    if(!confirm('Reset current course students to sample list?')) return;
    const cid = $('#courseSelect').value;
    const map = load(LS_STUDENTS, {});
    map[cid] = [...SAMPLE_STUDENTS];
    save(LS_STUDENTS, map);
    renderAttendanceTable($('#search').value);
    renderCoursesTable();
  });

  $('#clearData').addEventListener('click', ()=>{
    if(!confirm('Clear ALL attendance & students for ALL courses?')) return;
    localStorage.removeItem(LS_ATT);
    localStorage.removeItem(LS_STUDENTS);
    ensureSeed();
    hydrateCourseSelectors();
    renderAttendanceTable();
    renderCoursesTable();
  });

  // Export CSV for selected date
  $('#exportCsv').addEventListener('click', ()=>{
    const cid = $('#courseSelect').value; const date = $('#attDate').value || todayISO();
    const all = load(LS_ATT, {}); const rows = all?.[cid]?.[date];
    if(!rows || !rows.length) return alert('No records for '+date);
    const header = ['No','Name','StudentID','Status','Note'];
    const csv = [header.join(',')].concat(rows.map((r,i)=>[
      i+1,
      '"'+String(r.name).replace(/"/g,'""')+'"',
      '"'+String(r.id).replace(/"/g,'""')+'"',
      r.status,
      '"'+String(r.note||'').replace(/"/g,'""')+'"'
    ].join(','))).join('');
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `${cid}-attendance-${date}.csv`; a.click(); URL.revokeObjectURL(url);
  });

  // Export ALL dates (sequential downloads)
  $('#exportAll').addEventListener('click', ()=>{
    const cid = $('#courseSelect').value; const all = load(LS_ATT, {}); const obj = all?.[cid]||{}; const keys = Object.keys(obj);
    if(keys.length===0) return alert('No saved dates.');
    if(!confirm(`Export ${keys.length} CSV file(s)?`)) return;
    keys.sort().forEach((d,i)=> setTimeout(()=>{
      $('#attDate').value = d; renderAttendanceTable(); document.getElementById('exportCsv').click();
    }, i*500));
  });

  // Report inside Attendance tab
  $('#showReport').addEventListener('click', ()=>{
    const cid = $('#courseSelect').value; const all = load(LS_ATT, {}); const obj = all?.[cid]||{}; const dates = Object.keys(obj);
    const map = {};
    dates.forEach(date=>{
      (obj[date]||[]).forEach(r=>{
        const k = r.id || r.name; if(!map[k]) map[k] = { name:r.name, id:r.id, present:0, total:0 };
        if(r.status==='present') map[k].present++; map[k].total++;
      });
    });
    const arr = Object.values(map).map(s=>({ ...s, percent: s.total? Math.round((s.present/s.total)*100) : 0 })).sort((a,b)=>b.percent-a.percent);
    const list = arr.map(r=>`<div class="flex items-center justify-between py-2">
      <div><b>${escapeHtml(r.name)}</b><div class="text-xs text-gray-500">${escapeHtml(r.id)}</div></div>
      <div class="text-right"><div class="font-semibold">${r.percent}%</div><div class="text-xs text-gray-500">${r.present}/${r.total} present</div></div>
    </div>`).join('');
    $('#reportList').innerHTML = list || '<div class="text-sm text-gray-500">No saved attendance.</div>';
    $('#reportArea').classList.remove('hidden');
  });

  // ---------- Summary Tab (semester view) ----------
  function updateSummarySelectors(){
    const courses = load(LS_COURSES, []);
    $('#summaryCourse').innerHTML = courses.map(c=>`<option value="${escapeAttr(c.id)}">${escapeHtml(c.name)} (${c.id})</option>`).join('');
    if(!$('#fromDate').value) $('#fromDate').value = todayISO();
    if(!$('#toDate').value) $('#toDate').value = todayISO();
  }

  $('#runSummary').addEventListener('click', ()=>{
    const cid = $('#summaryCourse').value; const from = $('#fromDate').value; const to = $('#toDate').value;
    const all = load(LS_ATT, {}); const obj = all?.[cid]||{}; const dates = Object.keys(obj).filter(d=>(!from||d>=from) && (!to||d<=to));
    const map = {};
    dates.forEach(date=>{
      (obj[date]||[]).forEach(r=>{
        const k = r.id || r.name; if(!map[k]) map[k] = { name:r.name, id:r.id, present:0, total:0 };
        if(r.status==='present') map[k].present++; map[k].total++;
      });
    });
    const arr = Object.values(map).map(s=>({ ...s, percent: s.total? Math.round((s.present/s.total)*100) : 0 })).sort((a,b)=>b.percent-a.percent);
    const html = `
      <div class="overflow-auto rounded-xl border">
        <table class="w-full text-sm">
          <thead class="bg-gray-50">
            <tr class="text-gray-500">
              <th class="text-left p-3">Name</th>
              <th class="text-left p-3">ID</th>
              <th class="text-left p-3">Present</th>
              <th class="text-left p-3">Total</th>
              <th class="text-left p-3">Percent</th>
            </tr>
          </thead>
          <tbody>
            ${arr.map(r=>`<tr class="border-b">
              <td class="p-3">${escapeHtml(r.name)}</td>
              <td class="p-3">${escapeHtml(r.id)}</td>
              <td class="p-3">${r.present}</td>
              <td class="p-3">${r.total}</td>
              <td class="p-3 font-semibold">${r.percent}%</td>
            </tr>`).join('')}
          </tbody>
        </table>
      </div>`;
    $('#summaryResult').innerHTML = html || '<div class="text-sm text-gray-500">No data in this range.</div>';
  });

  // ---------- Escapes ----------
  function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  function escapeAttr(s){ return String(s||'').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }

  // ---------- Init ----------
  boot();
  </script>
</body>
</html>
